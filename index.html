<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#f8f9fa">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Spool Manager | v2.0.0 Modular</title>
    
    <!-- PWA Manifest (Generic) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiU3Bvb2wgTWFuYWdlciIsInNob3J0X25hbWUiOiJTcG9vbCBNZ3IiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzIxMjUyOSIsInRoZW1lX2NvbG9yIjoiIzIxMjUyOSIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2Nkbi1pY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi85MDAvOTAwNjk5LnBuZyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifV19">
    
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6f42c1;
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --bg-light-override: #f8f9fa;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --card-radius: 16px;
            --success-soft: #d1fae5;
            --success-text: #065f46;
            --table-hover-bg: #f1f5f9;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
            --modal-header-bg: #f8f9fa;
        }

        [data-theme="dark"] {
            --primary-color: #3b82f6;
            --secondary-color: #a855f7;
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-light-override: #334155;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --success-soft: #064e3b;
            --success-text: #6ee7b7;
            --table-hover-bg: #2d3748;
            --glass-bg: rgba(15, 23, 42, 0.85);
            --glass-border: rgba(255, 255, 255, 0.05);
            --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            --modal-header-bg: #1e293b;
            
            --bs-body-color: var(--text-main);
            --bs-heading-color: var(--text-main);
            --bs-card-color: var(--text-main);
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            padding-bottom: calc(90px + env(safe-area-inset-bottom)); 
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden; 
        }

        .navbar-glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--glass-shadow);
            z-index: 1020;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--card-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            color: var(--text-main);
        }

        [data-theme="dark"] .bg-light { background-color: var(--bg-light-override) !important; }
        [data-theme="dark"] .text-muted { color: #94a3b8 !important; }
        [data-theme="dark"] .border { border-color: var(--border-color) !important; }

        .form-control, .form-select, .input-group-text {
            background-color: var(--bg-card);
            border-color: var(--border-color);
            color: var(--text-main);
        }
        
        [data-theme="dark"] .form-control, 
        [data-theme="dark"] .form-select,
        [data-theme="dark"] .input-group-text {
            background-color: #334155;
            border-color: #475569;
            color: #f8fafc;
        }
        
        [data-theme="dark"] .form-control::placeholder { color: #cbd5e1; opacity: 0.5; }
        [data-theme="dark"] .btn-light {
            background-color: var(--bg-light-override);
            border-color: var(--border-color);
            color: var(--text-main);
        }
        [data-theme="dark"] .btn-light:hover { background-color: #475569; }

        [data-theme="dark"] .dropdown-menu {
            background-color: var(--bg-card);
            border-color: var(--border-color);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        [data-theme="dark"] .dropdown-item { color: var(--text-main); }
        [data-theme="dark"] .dropdown-item:hover { background-color: var(--bg-light-override); }

        [data-theme="dark"] .modal-content { background-color: var(--bg-card); border-color: var(--border-color); color: var(--text-main); }
        [data-theme="dark"] .modal-header, [data-theme="dark"] .modal-footer { border-color: var(--border-color); }
        [data-theme="dark"] .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }

        .table { --bs-table-color: var(--text-main); --bs-table-bg: transparent; --bs-table-border-color: var(--border-color); }
        .table-hover tbody tr:hover { background-color: var(--table-hover-bg); }
        [data-theme="dark"] thead.bg-light th { background-color: var(--bg-light-override); color: var(--text-main); }
        
        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; }
        th.sortable:hover { background-color: rgba(0,0,0,0.05); }
        [data-theme="dark"] th.sortable:hover { background-color: rgba(255,255,255,0.05); }
        th.sortable i { margin-left: 5px; opacity: 0.3; }
        th.sortable.active i { opacity: 1; color: var(--primary-color); }

        .font-mono { font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; }
        
        .badge-soft-primary { background: rgba(13, 110, 253, 0.1); color: #0d6efd; }
        [data-theme="dark"] .badge-soft-primary { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        
        .badge-soft-secondary { background: rgba(111, 66, 193, 0.1); color: #6f42c1; }
        [data-theme="dark"] .badge-soft-secondary { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        
        .fab-btn {
            position: fixed; bottom: 90px; right: 20px;
            width: 56px; height: 56px; border-radius: 28px;
            background: var(--primary-color); color: white;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; border: none; z-index: 1040;
            transition: transform 0.2s;
            margin-bottom: env(safe-area-inset-bottom);
        }
        .fab-btn:hover { transform: scale(1.05); color: white; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-color);
            display: none; justify-content: space-around; 
            padding: 10px 0 calc(10px + env(safe-area-inset-bottom)) 0;
            z-index: 1030;
        }
        .nav-item-mobile {
            text-align: center; color: var(--text-muted); text-decoration: none;
            font-size: 0.75rem; flex: 1; border: none; background: transparent;
        }
        .nav-item-mobile.active { color: var(--primary-color); font-weight: 600; }
        .nav-item-mobile i { font-size: 1.25rem; display: block; margin-bottom: 4px; }

        #bulkActionsPanel {
            position: fixed; bottom: 20px; left: 50%; 
            transform: translate(-50%, 400%);
            background: #1e293b; color: white;
            padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1050; display: flex; align-items: center; gap: 15px;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255,255,255,0.1);
        }
        #bulkActionsPanel.visible { transform: translate(-50%, 0); }
        [data-theme="light"] #bulkActionsPanel { background: #212529; }

        @media (max-width: 991px) {
            .bottom-nav { display: flex; }
            .desktop-nav { display: none !important; }
            .table thead { display: none; }
            
            .table tr { 
                display: block; 
                margin-bottom: 1rem; 
                border: 1px solid var(--border-color); 
                border-radius: 12px; 
                background: var(--bg-card); 
                overflow: hidden; 
                position: relative; 
                transition: transform 0.2s ease-out;
            }
            .table tr.swiped { transform: translateX(-140px); }
            
            .mobile-actions-layer {
                position: absolute;
                top: 0; bottom: 0; right: -140px;
                width: 140px; 
                display: flex;
                z-index: 1;
            }
            .mobile-action-btn {
                flex: 1;
                display: flex; align-items: center; justify-content: center;
                color: white; font-size: 1.2rem; border: none;
                cursor: pointer;
            }
            .mobile-edit-btn { background-color: #f59e0b; }
            .mobile-delete-btn { background-color: #ef4444; }

            .mobile-row-content {
                position: relative;
                z-index: 2;
                background: var(--bg-card);
                transition: transform 0.2s ease-out;
                width: 100%;
            }

            .table td { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding: 12px 15px; }
            .table td:last-child { border-bottom: 0; background: rgba(0,0,0,0.02); }
            .table td::before { content: attr(data-label); font-weight: 600; color: var(--text-muted); font-size: 0.75rem; margin-right: auto; }
            .hide-on-mobile { display: none !important; }
            
            #bulkActionsPanel { 
                bottom: 85px; width: 90%; max-width: 400px; justify-content: space-between;
                margin-bottom: env(safe-area-inset-bottom);
            }
            .form-check-input { transform: scale(1.2); }
            .hover-actions { opacity: 1 !important; }
        }

        .offcanvas { background-color: var(--bg-body); color: var(--text-main); }
        .offcanvas-header { background-color: var(--bg-card); border-bottom: 1px solid var(--border-color); }
        .offcanvas-footer { background-color: var(--bg-card); border-top: 1px solid var(--border-color); padding: 1rem; }
        
        .modern-modal-header {
            background-color: var(--modal-header-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem;
        }
        
        .menu-grid-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
            color: var(--text-main);
            height: 100%;
        }
        .menu-grid-btn:hover {
            background: var(--bg-light-override);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .menu-grid-btn i { font-size: 1.5rem; margin-bottom: 0.5rem; display: block; }
        [data-theme="dark"] .menu-grid-btn:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        .toast-container { z-index: 3000; }
        
        #qr-reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
        }
        #qr-reader video { object-fit: cover; }
        
        @media print {
            .no-print, .fab-btn, .bottom-nav, #bulkActionsPanel { display: none !important; }
            body { padding-bottom: 0; background: white; }
            .card { border: none; box-shadow: none; }
        }
        
        .fade-in-row { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .skeleton { background: #e2e8f0; border-radius: 6px; display: inline-block; height: 1em; width:100%;}
        [data-theme="dark"] .skeleton { background: #334155; }

        .row-new {
            background-color: var(--success-soft) !important;
            transition: background-color 0.5s;
        }
        .row-new td {
            background-color: transparent !important; 
        }
        .new-indicator {
            height: 8px; width: 8px; 
            background-color: var(--success-text); 
            border-radius: 50%; 
            display: inline-block;
            margin-right: 6px;
            box-shadow: 0 0 5px var(--success-text);
        }
        
        .shipment-search-results {
            position: absolute; width: 100%; max-height: 200px; overflow-y: auto;
            z-index: 1000; background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .shipment-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; border-bottom: 1px solid var(--border-color);
        }
        .shipment-item:last-child { border-bottom: none; }

        .progress-container { margin-top: 15px; display: none; }
    </style>
</head>
<body>

<!-- Toast -->
<div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

<!-- Bulk Actions Panel -->
<div id="bulkActionsPanel">
    <div class="d-flex align-items-center">
        <span class="badge bg-white text-dark me-2 rounded-pill" id="selectedCount">0</span>
        <span class="small fw-bold">Выбрано</span>
    </div>
    <div class="vr bg-secondary opacity-50 mx-2"></div>
    <div class="d-flex gap-2">
        <button class="btn btn-sm btn-light rounded-circle" onclick="window.openBulkEdit()" title="Изменить">
            <i class="fas fa-pen"></i>
        </button>
        <button class="btn btn-sm btn-light rounded-circle" onclick="window.bulkPrintPassports()" title="Печать Паспортов">
            <i class="fas fa-file-pdf"></i>
        </button>
        <button class="btn btn-sm btn-light rounded-circle" onclick="window.bulkPrint()" title="Печать QR">
            <i class="fas fa-qrcode"></i>
        </button>
        <button class="btn btn-sm btn-danger rounded-circle" onclick="window.bulkDeleteConfirm()" title="Удалить">
            <i class="fas fa-trash"></i>
        </button>
        <button class="btn btn-sm btn-outline-light border-0 rounded-circle" onclick="window.clearSelection()" title="Сброс">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<!-- Offcanvas Form -->
<div class="offcanvas offcanvas-end shadow-lg" tabindex="-1" id="editorOffcanvas" data-bs-scroll="true">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title fw-bold" id="offcanvasTitle">
            <i class="fas fa-circle-notch text-primary me-2"></i>Катушка
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" onclick="window.closeOffcanvas()"></button>
    </div>
    <div class="offcanvas-body p-0">
        <form id="maskForm" class="p-3">
            <input type="hidden" id="editId">
            <div class="card mb-3 p-3 border-0 shadow-sm">
                <label class="small text-muted fw-bold text-uppercase mb-2">Статус</label>
                <div class="form-check form-switch p-0 m-0 d-flex justify-content-between align-items-center">
                    <label class="form-check-label" for="isInCRM">Внесено в CRM</label>
                    <input class="form-check-input ms-2" type="checkbox" role="switch" id="isInCRM" style="width: 3em; height: 1.5em;">
                </div>
            </div>
            
            <div class="card mb-3 p-3 border-0 shadow-sm">
                <label class="small text-muted fw-bold text-uppercase mb-2">Идентификация</label>
                <div class="mb-3">
                    <label class="form-label small d-flex justify-content-between">
                        Серийный номер
                        <span class="badge bg-light text-primary border cursor-pointer" onclick="window.updateSmartSerial()" title="Пересчитать по формуле"><i class="fas fa-magic me-1"></i>Авто</span>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                        <input type="text" class="form-control fw-bold font-mono fs-5" id="serialNumber" placeholder="M3/2023.457" required autocomplete="off">
                    </div>
                </div>
                
                <div class="row g-2 mb-3">
                     <div class="col-8">
                        <label class="form-label small text-muted">Префикс</label>
                        <input type="text" class="form-control font-mono" id="serialPrefix" value="M3/2023.">
                    </div>
                    <div class="col-4">
                        <label class="form-label small text-muted">Сквозной №</label>
                         <div class="input-group">
                             <input type="number" class="form-control" id="globalSeq" required oninput="window.checkSeqUniqueness()">
                             <button type="button" class="btn btn-outline-secondary" onclick="window.setAutoSeq()" title="Сгенерировать">
                                <i class="fas fa-sync-alt"></i>
                             </button>
                         </div>
                    </div>
                    <div class="col-12">
                        <div id="seqWarning" class="small text-danger fw-bold d-none"><i class="fas fa-exclamation-triangle me-1"></i>Этот номер уже занят!</div>
                    </div>
                </div>
            </div>

            <div class="card mb-3 p-3 border-0 shadow-sm">
                <label class="small text-muted fw-bold text-uppercase mb-2">Спецификация</label>
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label small">Провод</label>
                        <select class="form-select" id="wireType" onchange="window.handleWireChange('standard')">
                            <option value="Китайский">Китайский</option>
                            <option value="Favero">Favero</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label small">Модель (Год)</label>
                        <select class="form-select bg-light" id="spoolModel" disabled>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                </div>
                 <div class="row g-2 mb-3">
                    <div class="col-7">
                        <label class="form-label small">Месяц</label>
                        <select class="form-select" id="prodMonth">
                            <!-- Months populated by JS -->
                        </select>
                    </div>
                    <div class="col-5">
                        <label class="form-label small">Год</label>
                        <input type="number" class="form-control" id="prodYear">
                    </div>
                </div>

                <div>
                    <label class="form-label small">Примечания</label>
                    <textarea class="form-control" id="notes" rows="3"></textarea>
                </div>
            </div>
        </form>
    </div>
    <div class="offcanvas-footer d-flex gap-2">
        <button type="button" class="btn btn-light text-danger flex-grow-1" id="deleteBtnInForm" onclick="window.deleteFromForm()" style="display:none;">
            <i class="fas fa-trash-alt me-2"></i>Удалить
        </button>
        <button type="button" class="btn btn-primary flex-grow-1" onclick="window.saveRecord()">
            <i class="fas fa-save me-2"></i>Сохранить
        </button>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Настройки моделей</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-light small border mb-3">
                    <i class="fas fa-info-circle text-primary me-2"></i>Добавьте год и EAN штрихкоды.
                </div>
                <div id="settingsList" class="d-flex flex-column gap-2"></div>
                <button class="btn btn-sm btn-outline-primary mt-3 w-100" onclick="window.addSettingRow()">
                    <i class="fas fa-plus"></i> Добавить год
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary w-100" onclick="window.saveSettings()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Header Desktop -->
<nav class="navbar navbar-expand-lg sticky-top navbar-glass px-3 mb-3 no-print">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center gap-2 fw-bold" href="#">
            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center shadow-sm" style="width:36px;height:36px;">
                <i class="fas fa-circle-notch"></i>
            </div>
            <span style="color: var(--text-main)">Катушки<span class="text-primary">4F</span></span>
        </a>
        
        <div class="d-flex align-items-center gap-2 desktop-nav">
             <div id="connectionStatus" class="d-none d-md-flex align-items-center small me-3 px-2 py-1 rounded bg-light border">
                <span class="spinner-border spinner-border-sm me-2"></span> Init...
            </div>
            
            <button onclick="window.openShipmentModal()" class="btn btn-primary rounded-circle border shadow-sm" title="Буфер отгрузки">
                <i class="fas fa-truck-loading text-white"></i>
            </button>
            
            <button onclick="window.openBulkAdd()" class="btn btn-light rounded-circle border" title="Массовое добавление"><i class="fas fa-layer-group text-primary"></i></button>
            <button onclick="window.openSettings()" class="btn btn-light rounded-circle border" title="Настройки"><i class="fas fa-cog text-secondary"></i></button>
            <div class="vr bg-secondary opacity-25 mx-1"></div>
            <button onclick="window.toggleTheme()" class="btn btn-light rounded-circle border" title="Тема"><i class="fas fa-moon" id="themeIcon"></i></button>
        </div>
        
        <!-- Mobile Header Actions -->
        <div class="d-flex d-lg-none gap-2">
             <button onclick="window.openShipmentModal()" class="btn btn-sm btn-primary rounded-circle border"><i class="fas fa-truck-loading"></i></button>
             <button onclick="window.openBulkAdd()" class="btn btn-sm btn-light rounded-circle border"><i class="fas fa-layer-group text-primary"></i></button>
             <button onclick="window.toggleTheme()" class="btn btn-sm btn-light rounded-circle border"><i class="fas fa-moon"></i></button>
        </div>
    </div>
</nav>

<div class="container-fluid px-3 px-md-4 pb-5">
    <div class="tab-content" id="mainTabContent">
        <!-- INVENTORY -->
        <div class="tab-pane fade show active" id="inventory" role="tabpanel">
            <!-- Stats -->
            <div class="d-flex gap-3 overflow-auto pb-2 mb-3 no-scrollbar" style="scrollbar-width: none;">
                <div class="card p-3 flex-grow-1 shadow-sm" style="min-width: 130px; border-left: 4px solid #198754;">
                    <small class="text-muted fw-bold text-uppercase">Всего</small>
                    <div class="fs-4 fw-bold mt-1" id="totalCount"><div class="skeleton" style="width: 30px;"></div></div>
                </div>
                <div class="card p-3 flex-grow-1 shadow-sm" style="min-width: 130px; border-left: 4px solid var(--primary-color);">
                    <small class="text-muted fw-bold text-uppercase">Китайский</small>
                    <div class="fs-4 fw-bold mt-1 text-primary" id="stdCount"><div class="skeleton" style="width: 30px;"></div></div>
                </div>
                <div class="card p-3 flex-grow-1 shadow-sm" style="min-width: 130px; border-left: 4px solid var(--secondary-color);">
                    <small class="text-muted fw-bold text-uppercase">Favero</small>
                    <div class="fs-4 fw-bold mt-1" style="color: var(--secondary-color)" id="uCount"><div class="skeleton" style="width: 30px;"></div></div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-3 border-0 shadow-sm no-print">
                <div class="card-body p-2">
                    <div class="row g-2 align-items-center">
                        <div class="col-12 col-md-4">
                            <div class="input-group">
                                <span class="input-group-text bg-transparent border-end-0 text-muted"><i class="fas fa-search"></i></span>
                                <input type="text" id="searchSerial" class="form-control border-start-0 border-end-0" placeholder="Поиск... (Ctrl+F)" onkeyup="window.debouncedRender()">
                                <button class="btn btn-light border" type="button" onclick="window.openScanner()" title="Сканировать QR"><i class="fas fa-qrcode text-primary"></i></button>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <select id="filterModel" class="form-select form-select-sm border-0" onchange="window.renderTable()">
                                <option value="">Провод: Все</option>
                                <option value="Китайский">Китайский</option>
                                <option value="Favero">Favero</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-3">
                            <select id="filterCRM" class="form-select form-select-sm border-0" onchange="window.renderTable()">
                                <option value="">CRM: Все</option>
                                <option value="1">Внесено</option>
                                <option value="0">Не внесено</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-2 text-end d-none d-md-block">
                            <span class="text-muted small me-2" id="pageInfoDesktop"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="card border-0 shadow-sm overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4" style="width: 40px">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAll" onclick="window.toggleSelectAll()">
                                    </div>
                                </th>
                                <th class="sortable" onclick="window.handleSort('globalSeq')" style="width: 80px;">№ <i class="fas fa-sort small"></i></th>
                                <th class="sortable" onclick="window.handleSort('serial')">Катушка / SN <i class="fas fa-sort small"></i></th>
                                <th class="sortable" onclick="window.handleSort('wireType')">Провод <i class="fas fa-sort small"></i></th>
                                <th class="sortable" onclick="window.handleSort('spoolModel')">Модель <i class="fas fa-sort small"></i></th>
                                <th>Прим.</th>
                                <th class="text-end pe-4 no-print" style="min-width: 140px;">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                
                <div id="emptyState" class="text-center py-5 d-none">
                    <div class="mb-3"><div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;"><i class="fas fa-circle-notch fa-2x text-muted opacity-50"></i></div></div>
                    <h5 class="fw-bold text-muted">Список пуст</h5>
                    <p class="text-muted small mb-3">В базе данных пока нет катушек.</p>
                    <button class="btn btn-primary btn-sm px-4 rounded-pill shadow-sm" onclick="window.openCreate()"><i class="fas fa-plus me-1"></i> Добавить (N)</button>
                </div>
                
                <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light no-print">
                    <div class="d-flex align-items-center">
                        <select class="form-select form-select-sm border-0 bg-transparent text-muted" style="width:auto; cursor:pointer;" onchange="window.changePageSize(this.value)">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="small text-muted ms-1 d-none d-sm-inline">/ стр.</span>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-outline-secondary border-0" onclick="window.changePage(-1)"><i class="fas fa-chevron-left"></i></button>
                        <span class="small fw-bold text-muted" id="pageNumberDisplay">1</span>
                        <button class="btn btn-sm btn-outline-secondary border-0" onclick="window.changePage(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANALYTICS -->
        <div class="tab-pane fade" id="analytics" role="tabpanel">
             <div class="row g-3 justify-content-center">
                 <div class="col-md-6 col-lg-5">
                     <div class="card p-3 h-100 shadow-sm">
                         <h6 class="text-uppercase text-muted small fw-bold mb-3">Доли проводов</h6>
                         <div style="height: 300px;"><canvas id="modelPieChart"></canvas></div>
                     </div>
                 </div>
             </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<button class="fab-btn" onclick="window.openCreate()" title="Добавить (N)">
    <i class="fas fa-plus"></i>
</button>

<!-- Bottom Nav -->
<nav class="bottom-nav">
    <button class="nav-item-mobile active" onclick="window.switchTab('inventory')" id="nav-inv">
        <i class="fas fa-list"></i> Склад
    </button>
    <button class="nav-item-mobile" onclick="window.switchTab('analytics')" id="nav-stat">
        <i class="fas fa-chart-pie"></i> Инфо
    </button>
    <button class="nav-item-mobile" onclick="window.openMenuModal()">
        <i class="fas fa-bars"></i> Меню
    </button>
</nav>

<!-- Modals -->
<!-- SHIPMENT MODAL -->
<div class="modal fade" id="shipmentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
        <div class="modal-content" style="height: 90vh;">
            <div class="modal-header modern-modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-truck-loading me-2"></i>Буфер отгрузки
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-0 d-flex flex-column">
                
                <!-- Search Section -->
                <div class="p-3 bg-white shadow-sm border-bottom position-relative">
                    <div class="input-group">
                        <span class="input-group-text border-end-0 bg-transparent text-muted"><i class="fas fa-search"></i></span>
                        <input type="text" id="shipmentSearchInput" class="form-control border-start-0" placeholder="Поиск (SN или №)..." onkeyup="window.handleShipmentSearch(this.value)" onkeydown="window.handleShipmentKey(event)">
                        <button class="btn btn-light border" onclick="document.getElementById('shipmentSearchInput').value=''; window.handleShipmentSearch('')"><i class="fas fa-times"></i></button>
                    </div>
                    <!-- Search Results Dropdown -->
                    <div id="shipmentSearchResults" class="shipment-search-results d-none"></div>
                </div>

                <!-- Selected List -->
                <div class="flex-grow-1 overflow-auto p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6 class="text-uppercase text-muted small fw-bold mb-1">Выбрано: <span id="shipmentCount">0</span></h6>
                            <div id="shipmentSummary" class="d-flex flex-wrap gap-2 small"></div>
                        </div>
                        <button class="btn btn-sm btn-link text-danger text-decoration-none" onclick="window.clearShipmentBuffer()">Очистить всё</button>
                    </div>
                    <div id="shipmentBufferList" class="d-flex flex-column gap-2">
                        <div class="text-center text-muted py-5 mt-5">
                            <i class="fas fa-box-open fa-3x mb-3 opacity-50"></i>
                            <p>Список пуст</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-white border-top">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-outline-secondary" onclick="window.printShipmentList()">
                    <i class="fas fa-print me-2"></i>Печать листа
                </button>
                <button type="button" class="btn btn-primary" onclick="window.copyShipmentList()">
                    <i class="fas fa-copy me-2"></i>Скопировать список
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Импорт CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="importMsg" class="mb-2"></p>
                <div class="alert alert-light small mb-0 border">
                    <i class="fas fa-info-circle text-primary me-1"></i>
                    Формат CSV: <strong>Serial, Model, Notes</strong>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" data-bs-dismiss="modal">Отмена</button>
                <button class="btn btn-primary" onclick="window.confirmImport()">
                    <span id="importBtnText">Загрузить в БД</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center p-4"><i class="fas fa-trash-alt fa-3x text-warning mb-3"></i><h5 id="deleteTitle">Удалить?</h5><p class="small text-muted" id="deleteMsg">Это действие нельзя отменить.</p><div class="d-flex justify-content-center gap-2"><button class="btn btn-light" data-bs-dismiss="modal">Нет</button><button class="btn btn-danger" onclick="window.executeDelete()">Да, удалить</button></div></div></div></div></div>

<!-- MAIN MENU MODAL -->
<div class="modal fade" id="menuModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Меню</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-6">
                        <div class="menu-grid-btn" onclick="window.openBulkAdd(); bootstrap.Modal.getInstance(document.getElementById('menuModal')).hide();">
                            <i class="fas fa-layer-group text-success mb-2"></i>
                            <div class="small fw-bold">Массовое</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="menu-grid-btn" onclick="window.openShipmentModal(); bootstrap.Modal.getInstance(document.getElementById('menuModal')).hide();">
                            <i class="fas fa-truck-loading text-warning mb-2"></i>
                            <div class="small fw-bold">Отгрузка</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="menu-grid-btn" onclick="window.exportCSV(); bootstrap.Modal.getInstance(document.getElementById('menuModal')).hide();">
                            <i class="fas fa-file-csv text-info mb-2"></i>
                            <div class="small fw-bold">Экспорт</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="menu-grid-btn" onclick="document.getElementById('fileInput').click(); bootstrap.Modal.getInstance(document.getElementById('menuModal')).hide();">
                            <i class="fas fa-file-import text-secondary mb-2"></i>
                            <div class="small fw-bold">Импорт</div>
                        </div>
                    </div>
                    <div class="col-6">
                         <button class="menu-grid-btn w-100" onclick="window.openSettings(); bootstrap.Modal.getInstance(document.getElementById('menuModal')).hide();">
                            <i class="fas fa-cog text-primary mb-2"></i>
                            <div class="small fw-bold">Настройки</div>
                        </button>
                    </div>
                    <div class="col-6">
                        <div class="menu-grid-btn" onclick="window.clearLocalData()">
                            <i class="fas fa-eraser text-danger mb-2"></i>
                            <div class="small fw-bold">Сброс кэша</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Hidden File Input for Import -->
<input type="file" id="fileInput" style="display: none;" onchange="window.importData(this)" accept=".csv">

<!-- Bulk Edit Modal -->
<div class="modal fade" id="bulkEditModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Массовое изменение</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-muted mb-3">Изменения коснутся <strong id="bulkCountDisplay">0</strong> записей.</p><form id="bulkEditForm"><div class="row g-3"><div class="col-12"><label class="form-label small">Провод</label><select class="form-select form-select-sm" id="bulkWireType" onchange="window.handleWireChange('bulkEdit')"><option value="">(Не менять)</option><option value="Китайский">Китайский</option><option value="Favero">Favero</option></select></div><div class="col-12"><label class="form-label small">Модель (Год)</label><select class="form-select form-select-sm" id="bulkSpoolModel" disabled><option value="">(Не менять)</option></select></div><div class="col-12"><label class="form-label small">Статус CRM</label><select class="form-select form-select-sm" id="bulkCRMSelect"><option value="">(Не менять)</option><option value="1">Установить "Внесено"</option><option value="0">Установить "Не внесено"</option></select></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-light" data-bs-dismiss="modal">Отмена</button><button type="button" class="btn btn-primary" onclick="window.submitBulkEdit()">Применить</button></div></div></div></div>

<!-- Bulk Add Modal -->
<div class="modal fade" id="bulkAddModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-layer-group text-primary me-2"></i>Массовое добавление</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="small text-muted">Создание серии катушек.</p>
                <form id="bulkAddForm">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Количество <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="baCount" value="1" min="1" max="100" required>
                    </div>
                    <hr class="dropdown-divider my-3">
                    <div class="row g-3">
                        <div class="col-6">
                            <label class="form-label small">Префикс (M3/2023.)</label>
                            <input type="text" class="form-control form-control-sm" id="baPrefix" value="M3/2023.">
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Начальный номер</label>
                            <input type="number" class="form-control form-control-sm" id="baStartNum" placeholder="100">
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Провод</label>
                            <select class="form-select form-select-sm" id="baWireType" onchange="window.handleWireChange('bulkAdd')">
                                <option value="Китайский">Китайский</option>
                                <option value="Favero">Favero</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Модель (Год)</label>
                            <select class="form-select form-select-sm" id="baSpoolModel" disabled></select>
                        </div>
                        <div class="col-7">
                            <label class="form-label small">Месяц изготовления</label>
                            <select class="form-select form-select-sm" id="baMonth"></select>
                        </div>
                        <div class="col-5">
                            <label class="form-label small">Год</label>
                            <input type="number" class="form-control form-control-sm" id="baYear">
                        </div>
                    </div>
                    <!-- Progress Bar for Bulk Add -->
                    <div class="progress-container" id="baProgressContainer">
                        <div class="d-flex justify-content-between small text-muted mb-1">
                            <span>Создание записей...</span>
                            <span id="baProgressText">0%</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div id="baProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal" id="baCancelBtn">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="window.executeBulkAdd()" id="baSubmitBtn">Создать</button>
            </div>
        </div>
    </div>
</div>

<!-- Scanner Modal -->
<div class="modal fade" id="scannerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-0">
            <div class="modal-body p-0 text-center position-relative">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button>
                <div id="qr-reader" style="width: 100%;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script type="module" src="src/app.js"></script>
</body>
</html>

